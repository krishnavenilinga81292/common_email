<?xml version="1.0" encoding="UTF-8"?>

<mule xmlns:jms="http://www.mulesoft.org/schema/mule/jms"
	xmlns:anypoint-mq="http://www.mulesoft.org/schema/mule/anypoint-mq" xmlns:ee="http://www.mulesoft.org/schema/mule/ee/core"
	xmlns="http://www.mulesoft.org/schema/mule/core"
	xmlns:doc="http://www.mulesoft.org/schema/mule/documentation" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xsi:schemaLocation="
http://www.mulesoft.org/schema/mule/ee/core http://www.mulesoft.org/schema/mule/ee/core/current/mule-ee.xsd http://www.mulesoft.org/schema/mule/core http://www.mulesoft.org/schema/mule/core/current/mule.xsd
http://www.mulesoft.org/schema/mule/anypoint-mq http://www.mulesoft.org/schema/mule/anypoint-mq/current/mule-anypoint-mq.xsd
http://www.mulesoft.org/schema/mule/jms http://www.mulesoft.org/schema/mule/jms/current/mule-jms.xsd">
	<error-handler name="common-email-alert-aggregator-error-handler" doc:id="7ed43e88-2143-4414-a289-41e3436eea6b" >
		<on-error-propagate enableNotifications="true" logException="true" doc:name="On Error Propagate" doc:id="d2b32eeb-b14d-4d71-a414-9e9004979610" >
				<anypoint-mq:nack doc:name="Manual Nack" doc:id="c8c31197-01b1-491e-b905-b8706ece2f37" config-ref="error-notify-queue-anypoint-mq-config" ackToken="#[vars.currentAckToken30min]"/>
			<ee:transform doc:name="payload to error standard queue" doc:id="47680d5c-f7d6-499c-af55-a3361a61c35f" >
					<ee:message >
						<ee:set-payload ><![CDATA[%dw 2.0
output application/json
---
{
    "httpStatus" : "Not Applicable as it is a pub-sub pattern",
    "httpMethod" : "Not Applicable",
    "appName" : Mule::p('app.name'),
    "exceptionType" : error.errorType.namespace default "MULE" ++ ":" ++ error.errorType.identifier default "ANY",
    "correlationID" : correlationId,
    "timeStamp" : now() as String { format: "yyyy-MM-dd'T'HH:mm:ss" },
    "errorDescription" : error.errorMessage.payload default error.detailedDescription,   
    "toEmail" : Mule::p('email.to'),
    "fromEmail": "no-reply@shell.com",
    "environment" : Mule::p('mule.env'),
    "businessId" : Mule::p('app.businessId') default "NA"   
}]]></ee:set-payload>
					</ee:message>
				</ee:transform>
			<logger level="INFO" doc:name="Logger" doc:id="d157dcbd-fad9-44a4-9698-b45b771b3901" message="payload before sending to standard error queue -- #[payload]"/>
			<anypoint-mq:publish doc:name="publish-to-error-standardQueue" doc:id="932d1d67-5d18-4590-be66-cf243ef7fb3d" config-ref="error-notify-queue-anypoint-mq-config" destination="${mq.standardErrorQueue}" />
			</on-error-propagate>
	</error-handler>
</mule>
